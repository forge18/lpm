name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0.1.0)'
        required: false
        type: string

permissions:
  contents: write

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Get the release version
        id: version
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=${GITHUB_REF#refs/tags/v}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "version is: $VERSION"
      
      - name: Check that tag version and Cargo.toml version are the same
        if: github.event_name == 'push'
        shell: bash
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if ! grep -q "version = \"$VERSION\"" Cargo.toml; then
            echo "version does not match Cargo.toml" >&2
            exit 1
          fi
      
      - name: Extract changelog for version
        id: changelog
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          # Use Python to extract the changelog section reliably
          python3 << 'EOF'
          import re
          import sys
          
          version = "${{ steps.version.outputs.version }}"
          
          try:
              with open('CHANGELOG.md', 'r') as f:
                  content = f.read()
              
              # Find the section for this version
              pattern = rf'^## \[{re.escape(version)}\].*?(?=^## \[|\Z)'
              match = re.search(pattern, content, re.MULTILINE | re.DOTALL)
              
              if match:
                  notes = match.group(0).strip()
                  with open('release_notes.md', 'w') as f:
                      f.write(notes)
                  print(f"✓ Extracted changelog for v{version}")
                  sys.exit(0)
              else:
                  # Fallback: create default release note
                  repo = "${{ github.repository }}"
                  with open('release_notes.md', 'w') as f:
                      f.write(f"## Release v{version}\n\n")
                      f.write(f"See [CHANGELOG.md](https://github.com/{repo}/blob/main/CHANGELOG.md) for details.\n")
                  print(f"⚠ No changelog entry found for v{version}, using default")
                  sys.exit(0)
          except Exception as e:
              print(f"Error: {e}")
              sys.exit(1)
          EOF
          
          echo ""
          echo "Release notes:"
          cat release_notes.md

      - name: Create GitHub release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Release v${{ steps.version.outputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  upload-files:
    name: Upload Release Files
    needs: create-release
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v4
      
      - name: Get version
        id: version
        run: |
          VERSION="${{ github.event.inputs.version }}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Check for build files
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          RELEASE_DIR="releases/v${VERSION}"
          
          if [ ! -d "$RELEASE_DIR" ] || [ -z "$(ls -A "$RELEASE_DIR" 2>/dev/null)" ]; then
            echo "⚠ No build files found in ${RELEASE_DIR}/!"
            echo ""
            echo "Build files locally first:"
            echo "  ./scripts/build-installer.sh all"
            echo ""
            echo "Then commit and push the releases/ directory"
            exit 1
          fi
          
          echo "Found files in ${RELEASE_DIR}/:"
          ls -lh "$RELEASE_DIR"
      
      - name: Upload files to release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            releases/v${{ steps.version.outputs.version }}/*
          tag_name: v${{ steps.version.outputs.version }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
